generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  linkedInId    String?   @unique

  // Profile settings
  jobTitle          String?
  company           String?
  industry          String?
  specialties       String[]
  yearsOfExperience String?
  targetAudience    String?
  targetIndustries  String[]
  contentGoals      String[]
  preferredTone     String?   @default("professional")
  preferredLanguage String?   @default("fr")
  contentTopics     String[]
  uniqueValue       String?
  expertise         String[]
  personalBrand     String?
  postingFrequency  String?   @default("weekly")
  preferredPostTypes String[]
  phone             String?
  githubUrl         String?
  portfolioUrl      String?
  linkedInProfileUrl String?

  // Relations
  posts      Post[]
  accounts   Account[]
  sessions   Session[]
  schedules  Schedule[]
  prospects  Prospect[]
  jobAlerts  JobAlert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                       String  @id @default(auto()) @map("_id") @db.ObjectId
  userId                   String  @db.ObjectId
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.String
  access_token             String? @db.String
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.String
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Post {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  content   String
  status    String   @default("draft") // draft, ready, published
  imageUrl  String?  // Unsplash illustration image URL
  
  linkedInUrn String?  // URN of the LinkedIn post for API calls

  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([userId])
  @@index([status])
}

model Schedule {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   // Name of the schedule (e.g., "Monday posts")
  isActive    Boolean  @default(true)
  isRecurring Boolean  @default(true) // true = recurring, false = one-time
  
  // Schedule configuration
  dayOfWeek   Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  times       String[] // Array of times in HH:mm format (e.g., ["13:15", "18:15"])
  timezone    String   @default("Europe/Paris")
  
  // Agenda job reference
  agendaJobId String?  // Reference to the agenda job
  
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastRunAt   DateTime?
  nextRunAt   DateTime?

  @@index([userId])
  @@index([isActive])
}

model Prospect {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  userId          String    @db.ObjectId
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  linkedinUrl     String?
  email           String?
  company         String?
  status          String    @default("new") // new, contacted, replied, interested, converted, lost
  notes           String?
  lastContactDate  DateTime?
  followUpDate     DateTime?
  firstContactDate DateTime?

  // Enrichment fields (via Hunter Domain Search)
  companySize        String?   // e.g. "11-50"
  companyIndustry    String?
  companyDescription String?
  website            String?
  enrichedAt         DateTime?

  // Follow-up sequences
  sequences       Sequence[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([followUpDate])
}

model Sequence {
  id         String         @id @default(auto()) @map("_id") @db.ObjectId
  prospectId String         @db.ObjectId
  userId     String         @db.ObjectId
  name       String         // e.g. "Séquence Standard Freelance"
  prospect   Prospect       @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  steps      SequenceStep[]
  createdAt  DateTime       @default(now())

  @@index([prospectId])
  @@index([userId])
}

model SequenceStep {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  sequenceId   String    @db.ObjectId
  order        Int       // 1, 2, 3...
  relativeDays Int       // days after first contact (e.g. 0, 3, 7)
  actionType   String    // "connection", "message", "email", "call", "note"
  content      String?   // pre-written message or template
  status       String    @default("pending") // pending, sent, responded, skipped
  dueDate      DateTime?
  sentAt       DateTime?
  notes        String?
  sequence     Sequence  @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@index([status])
  @@index([dueDate])
}

model Usage {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  month  String // e.g. "2026-02"
  type   String // "email_search"
  count  Int    @default(0)

  @@unique([userId, month, type])
  @@index([userId])
}

// ── Job Alerts & Lead Discovery ──

model JobAlert {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String   // e.g. "Dev React Remote"
  keywords        String[] // ["react", "next.js", "typescript", "remote"]
  excludeKeywords String[] // words to filter out
  sources         String[] // ["remotive", "jobicy", "arbeitnow", "reddit", "hackernews"]
  maxPerDay       Int      @default(5)
  isActive        Boolean  @default(true)
  lastFetchAt     DateTime?
  matches         JobAlertMatch[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
}

model JobListing {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  externalId   String   @unique // dedupe key: source + original ID
  source       String   // "remotive", "jobicy", "arbeitnow", "reddit", "hackernews"
  title        String
  company      String?
  description  String?
  url          String   // link to the original posting / application page
  contactEmail String?  // extracted email if present in the post
  location     String?
  salary       String?
  tags         String[]
  publishedAt  DateTime
  fetchedAt    DateTime @default(now())
  matches      JobAlertMatch[]

  @@index([source])
  @@index([publishedAt])
}

model JobAlertMatch {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  userId       String     @db.ObjectId
  alertId      String     @db.ObjectId
  alert        JobAlert   @relation(fields: [alertId], references: [id], onDelete: Cascade)
  jobListingId String     @db.ObjectId
  jobListing   JobListing @relation(fields: [jobListingId], references: [id], onDelete: Cascade)
  status       String     @default("new") // new, saved, dismissed, added_to_crm
  // NOTE: "applied" status reserved for future auto-apply feature
  createdAt    DateTime   @default(now())

  @@unique([userId, jobListingId])
  @@index([userId, status])
  @@index([alertId])
}
